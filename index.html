<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>K-Pop Save One â€¢ Drop One</title>
<style>
  :root{
    --left:#FFC328; --right:#2F81FF; --panel:#0b0b14; --card:#ffffff;
    --ink:#0e0e14; --muted:#6b7280; --accent:#00e676; --danger:#ff3b3b; --radius:22px;
    --text-stroke-color: rgba(0,0,0,.92);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:linear-gradient(90deg,var(--left),var(--right));
    color:#fff; display:flex; flex-direction:column;
    transition: background .25s ease;
  }
  header{padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;}
  .brand{font-weight:900; letter-spacing:.5px; display:flex; align-items:center; gap:10px}
  .brand .pill{background:#111; padding:6px 10px; border-radius:999px; font-size:12px; color:#aaa}
  .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:flex-end}
  select,input[type="text"],input[type="number"]{
    appearance:none; border:none; outline:none; background:#111827; color:#e5e7eb;
    padding:10px 12px; border-radius:10px; min-width:180px
  }
  button{border:none; background:#111; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700}
  .btn-accent{background:var(--accent); color:#022b1a}
  .btn-ghost{background:#111827}
  .btn-danger{background:var(--danger)}
  .tog{display:flex; align-items:center; gap:8px; background:#111827; border-radius:999px; padding:6px 10px; cursor:pointer; user-select:none}
  .tog input{display:none}
  .dot{width:18px; height:18px; border-radius:999px; background:#333}
  .tog input:checked + .dot{background:var(--accent)}
  .bar{padding:6px 14px; background:#0b0b14; color:#cbd5e1; border-radius:999px; font-weight:700}
  .arena{flex:1; display:grid; grid-template-columns:1fr 80px 1fr; gap:12px; padding:14px; min-height:0}

  /* Sides */
  .side{
    position:relative;
    background:rgba(255,255,255,.15);
    border-radius:var(--radius);
    padding:16px; display:flex; flex-direction:column; gap:12px; backdrop-filter:blur(6px);
    transition: background .25s ease;
  }
  .side.left{background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.25)),var(--left)}
  .side.right{background:linear-gradient(180deg,rgba(0,0,0,.15),rgba(0,0,0,.25)),var(--right)}

  .frame{background:#fff; border-radius:20px; padding:10px; box-shadow:0 10px 30px rgba(0,0,0,.25);
         aspect-ratio:16/9; display:flex; align-items:center; justify-content:center}
  .frame iframe{width:100%; height:100%; border:0; border-radius:12px}

  /* Title/Artist with outline */
  .artist, .title{
    color:#fff;
    line-height:1.05;
    letter-spacing:.2px;
    -webkit-text-stroke: var(--stroke-size, 2px) var(--text-stroke-color);
    text-shadow:
      1px  1px 0 var(--text-stroke-color),
     -1px  1px 0 var(--text-stroke-color),
      1px -1px 0 var(--text-stroke-color),
     -1px -1px 0 var(--text-stroke-color),
      2px  0   0 var(--text-stroke-color),
     -2px  0   0 var(--text-stroke-color),
      0    2px 0 var(--text-stroke-color),
      0   -2px 0 var(--text-stroke-color);
  }
  .meta{text-align:center; background:#00000055; padding:10px; border-radius:12px}
  .artist{font-weight:900; font-size: clamp(28px, 3.8vw, 40px); --stroke-size: 1px;}
  .title {font-weight:800; font-size: clamp(22px, 3vw, 32px);  --stroke-size: 1px;}

  .tags{margin-top:6px; display:flex; flex-wrap:wrap; gap:6px; justify-content:center}
  .tag{background:#0b0b14; color:#cbd5e1; font-size:12px; padding:4px 8px; border-radius:999px}
  .actions{display:flex; gap:10px; justify-content:center; flex-wrap:wrap}
  .vs{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px}
  .vsBadge{font-size:44px; font-weight:900; background:#0b0b14; padding:10px 18px; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .rule{text-align:center; background:#0b0b14; color:#9ae6b4; padding:8px 12px; border-radius:999px; font-weight:900; font-size:14px}
  .sub{color:#cbd5e1; font-size:12px}

  /* Reveal veil */
  .veil{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center; gap:10px;
    padding:16px;
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.55));
    border-radius:var(--radius);
    visibility:hidden; opacity:0; transition:opacity .2s ease;
    pointer-events:none;                 /* don't block clicks when hidden */
  }
  .side.concealed .veil{
    visibility:visible; opacity:1;
    pointer-events:auto;                /* Only clickable while concealed */
  }
  .revealBtn{font-size:clamp(18px,2.4vw,22px); padding:14px 18px}
  .hint{font-size:12px; opacity:.8}

  /* Modal base */
  dialog{border:none; padding:0; border-radius:16px; width:min(720px,92vw); max-height:90vh; overflow:auto; box-shadow:0 20px 80px rgba(0,0,0,.5)}
  .modalHead{display:flex; justify-content:space-between; align-items:center; padding:12px 14px; background:#0b0b14; color:#fff}
  .modalBody{padding:14px; background:#0f172a; color:#e5e7eb}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-bottom:10px}
  .row > *{margin-right:6px}
  .muted{color:#9ca3af; font-size:12px}
  .spacer{height:8px}
  footer.modalFoot{padding:10px 14px; display:flex; justify-content:flex-end; gap:8px; background:#0b0b14}

  /* Stats layout */
  .statsGrid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .statCard{background:#0b0b14; border-radius:12px; padding:12px}
  .statCard h3{margin:0 0 8px 0; font-size:16px}
  .list{margin:0; padding:0; list-style:none}
  .list li{display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:10px; background:#0f1a2a; margin-bottom:6px}
  .list .name{font-weight:700; color:#e5e7eb}
  .list .count{background:#111827; color:#cbd5e1; padding:4px 8px; border-radius:999px; font-size:12px}
  .empty{padding:10px; text-align:center; color:#a1a1aa; background:#0f1a2a; border-radius:10px}

  /* Disabled vote buttons */
  button:disabled{opacity:.45; cursor:not-allowed}

  @media (max-width: 700px){ .statsGrid{grid-template-columns:1fr} }
  @media (max-width: 420px){
    .artist{ --stroke-size: 2.2px; }
    .title { --stroke-size: 1.8px; }
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <span style="font-size:22px">ðŸŽµ Save One â€¢ Drop One</span>
    <span class="pill">K-Pop Edition</span>
  </div>
  <div class="controls">
    <span class="bar" id="categoryLabel">Category: â€”</span>

    <select id="categorySelect" title="Category"></select>

    <input id="yearInput" type="number" placeholder="Year (e.g., 2024)" style="width:140px;display:none"/>
    <input id="letterInput" type="text" maxlength="1" placeholder="Letter (A-Z)" style="width:120px;text-transform:uppercase;display:none"/>

    <button class="btn-ghost" id="btnNewPair">New Pair</button>
    <button class="btn-ghost" id="btnOptions">Options</button>
    <button class="btn-ghost" id="btnStats">Stats</button>
  </div>
</header>

<main class="arena">
  <section class="side left concealed" id="leftCard">
    <div class="frame"><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
    <div class="meta">
      <div class="artist" id="leftArtist">â€”</div>
      <div class="title" id="leftTitle">â€”</div>
      <div class="tags" id="leftTags"></div>
    </div>
    <div class="actions">
      <button class="btn-accent" id="saveLeft" disabled title="Reveal both sides to vote">Save Left</button>
    </div>
    <div class="veil">
      <button class="btn-accent revealBtn" id="revealLeft">Reveal</button>
      <span class="hint">Tap to reveal before voting</span>
    </div>
  </section>

  <section class="vs">
    <div class="rule" id="ruleBadge">RULE</div>
    <div class="vsBadge">VS</div>
    <div class="sub" id="score">Choices: 0</div>
  </section>

  <section class="side right concealed" id="rightCard">
    <div class="frame"><iframe allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>
    <div class="meta">
      <div class="artist" id="rightArtist">â€”</div>
      <div class="title" id="rightTitle">â€”</div>
      <div class="tags" id="rightTags"></div>
    </div>
    <div class="actions">
      <button class="btn-accent" id="saveRight" disabled title="Reveal both sides to vote">Save Right</button>
    </div>
    <div class="veil">
      <button class="btn-accent revealBtn" id="revealRight">Reveal</button>
      <span class="hint">Tap to reveal before voting</span>
    </div>
  </section>
</main>

<!-- Options Modal -->
<dialog id="opts">
  <div class="modalHead">
    <strong>Options</strong>
    <button class="btn-ghost" id="btnCloseOpts">âœ•</button>
  </div>
  <div class="modalBody">
    <div class="row">
      <label class="tog" title="Start the video at each song's highlight">
        <input id="toggleHighlight" type="checkbox" checked />
        <span class="dot"></span><span>Start at highlight</span>
      </label>

      <label class="tog" title="Keep the winner facing new challengers">
        <input id="championMode" type="checkbox" />
        <span class="dot"></span><span>Champion mode</span>
      </label>
    </div>

    <div class="row">
      <label class="tog" title="Automatically reveal both sides each round">
        <input id="autoReveal" type="checkbox" />
        <span class="dot"></span><span>Auto reveal</span>
      </label>

      <select id="revealOrder" title="Reveal order">
        <option value="random">Order: Random</option>
        <option value="leftFirst">Order: Left â†’ Right</option>
        <option value="rightFirst">Order: Right â†’ Left</option>
      </select>
      <span class="muted">Controls which side reveals first while Auto reveal is on.</span>
    </div>

    <div class="row">
      <label class="tog" title="Show song tags under each card">
        <input id="showTags" type="checkbox" />
        <span class="dot"></span><span>Show tags</span>
      </label>
    </div>

    <div class="spacer"></div>
    <div class="row">
      <button class="btn-ghost" id="btnHardRefresh" title="Clear caches and reload">Hard Refresh</button>
      <span class="muted">Useful if a deploy seems cached.</span>
    </div>
  </div>
  <footer class="modalFoot">
    <button class="btn-accent" id="btnDoneOpts">Done</button>
  </footer>
</dialog>

<!-- Stats Modal -->
<dialog id="statsDlg">
  <div class="modalHead">
    <strong>Player Stats</strong>
    <button class="btn-ghost" id="btnCloseStats">âœ•</button>
  </div>
  <div class="modalBody">
    <div class="row" style="justify-content:space-between; width:100%">
      <div class="muted" id="totalChoicesLabel">Total choices: 0</div>
      <button class="btn-danger" id="btnResetStats" title="Clear all saved counts">Reset stats</button>
    </div>
    <div class="statsGrid">
      <div class="statCard">
        <h3>Top 5 Artists</h3>
        <ul class="list" id="topArtists"></ul>
      </div>
      <div class="statCard">
        <h3>Top 5 Songs</h3>
        <ul class="list" id="topSongs"></ul>
      </div>
    </div>
  </div>
  <footer class="modalFoot">
    <button class="btn-accent" id="btnDoneStats">Done</button>
  </footer>
</dialog>

<!-- SFX -->
<audio id="sfxPop" src="pop.mp3" preload="auto"></audio>

<script>
/* ---------- Config for auto reveal ---------- */
const AUTO_FIRST_MS = 300;   // delay before first reveal
const AUTO_GAP_MS   = 1200;  // gap between first and second reveal


const SONGS = Object.freeze([
  { id:"lesserafim-crazy", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"Crazy", year:2024, debut:false, youtubeId:"n6B5gQXlB-0", tags:["Letter: C"], highlight:64, songStart:0, color:"#ff6aa0" },
  { id:"aespa-whiplash", artist:"aespa", group:"aespa", gender:"girls", company:"SM", title:"Whiplash", year:2024, debut:false, youtubeId:"jWQx2f-CErU", tags:["Letter: W"], highlight:36, songStart:0, color:"#7a8cff" },
  { id:"newjeans-omg", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"OMG", year:2023, debut:false, youtubeId:"sVTy_wmn5SU", tags:["Letter: O"], highlight:45, songStart:0, color:"#00d0b3" },
  { id:"ive-eleven", artist:"IVE", group:"IVE", gender:"girls", company:"Starship", title:"LOVE DIVE", year:2021, debut:false, youtubeId:"Y8JFxS1HlDo", tags:["Letter: L", "Love"], highlight:54, songStart:0, color:"#7dd3fc" },
  { id:"itzy-dalla", artist:"ITZY", group:"ITZY", gender:"girls", company:"JYP", title:"DALLA DALLA", year:2019, debut:true, youtubeId:"pNfTK39k55U", tags:["Letter: D","Debut"], highlight:69, songStart:0, color:"#fbbf24" },
  { id:"twice-tth", artist:"TWICE", group:"TWICE", gender:"girls", company:"JYP", title:"Talk That Talk", year:2022, debut:false, youtubeId:"k6jqx9kZgPM", tags:["Letter: T"], highlight:57, songStart:0, color:"#22c55e" },
  { id:"idle-queencard", artist:"(G)I-DLE", group:"(G)I-DLE", gender:"girls", company:"CUBE", title:"Queencard", year:2023, debut:false, youtubeId:"7HDeem-JaSY", tags:["Letter: Q"], highlight:61, songStart:0, color:"#f472b6" },
  { id:"illit-magnetic", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"Magnetic", year:2024, debut:true, youtubeId:"Vk5-c_v4gMU", tags:["Letter: M","Debut"], highlight:97, songStart:0, color:"#34d399" },
  { id:"illit-jellyous", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"jellyous", year:2025, debut:false, youtubeId:"GkG60kISnfc", tags:["Letter: J"], highlight:49, songStart:0, color:"#60a5fa" },
  { id:"illit-dtd", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"Billyeoon Goyangi (Do the Dance)", year:2025, debut:false, youtubeId:"negtrQu5mTA", tags:["Letter: B"], highlight:70, songStart:0, color:"#a78bfa" },
  { id:"fromis9-lkubetter", artist:"fromis_9", group:"fromis_9", gender:"girls", company:"ASND", title:"Like You Better", year:2025, debut:false, youtubeId:"r1QapH1SIAI", tags:["Letter: L"], highlight:53, songStart:0, color:"#fb7185" },
  { id:"h2h-style", artist:"Hearts2Hearts", group:"Hearts2Hearts", gender:"girls", company:"SM", title:"Style", year:2025, debut:false, youtubeId:"n7kFRxFIPrI", tags:["Letter: S"], highlight:51, songStart:0, color:"#f59e0b" },
  { id:"illit-ticktack", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"Tick-Tack", year:2024, debut:false, youtubeId:"-nEGVrzPaiU", tags:["Letter: T"], highlight:68, songStart:0, color:"#ffa9ca" },
  { id:"illit-cherish", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"Cherish (My Love)", year:2024, debut:false, youtubeId:"tbDGl7jEazA", tags:["Letter: C", "Love"], highlight:52, songStart:0, color:"#c9024e" },
  { id:"illit-lgs", artist:"ILLIT", group:"ILLIT", gender:"girls", company:"HYBE", title:"Lucky Girl Syndrome", year:2024, debut:false, youtubeId:"UCmgGZbfjmk", tags:["Letter: L", "Girl"], highlight:38, songStart:0, color:"#9fff81" },
  { id:"bdc-fgirl", artist:"Baby DONT Cry", group:"Baby DONT Cry", gender:"girls", company:"P Nation", title:"F Girl", year:2025, debut:true, youtubeId:"fmGBeGSp7fs", tags:["Letter: F", "Girl", "Debut"], highlight:61, songStart:0, color:"#ef242a" },
  { id:"bdc-byr", artist:"Baby DONT Cry", group:"Baby DONT Cry", gender:"girls", company:"P Nation", title:"Bet You'll Regret It", year:2025, debut:false, youtubeId:"uWT79Qq52sU", tags:["Letter: B"], highlight:92, songStart:0, color:"#ef242a" },
  { id:"huntrix-golden", artist:"Huntr/x", group:"Huntr/x", gender:"girls", company:"K-Pop Demon Hunters", title:"Golden", year:2025, debut:false, youtubeId:"yebNIHKAC4A", tags:["Letter: G"], highlight:64, songStart:0, color:"#ffc110" },
  { id:"huntrix-hid", artist:"Huntr/x", group:"Huntr/x", gender:"girls", company:"K-Pop Demon Hunters", title:"How It's Done", year:2025, debut:false, youtubeId:"QGsevnbItdU", tags:["Letter: H"], highlight:52, songStart:0, color:"#9af5ff" },
  { id:"smn-waveway", artist:"SAY MY NAME", group:"SAY MY NAME", gender:"girls", company:"Inkode", title:"WaveWay", year:2024, debut:true, youtubeId:"LzeUBByxQKo", tags:["Letter: W"], highlight:53, songStart:0, color:"#26e5ff" },
  { id:"smn-shalala", artist:"SAY MY NAME", group:"SAY MY NAME", gender:"girls", company:"Inkode", title:"ShaLala", year:2025, debut:false, youtubeId:"rPEfIvfmCxM", tags:["Letter: S"], highlight:58, songStart:0, color:"#0066ff" },
  { id:"smn-ily", artist:"SAY MY NAME", group:"SAY MY NAME", gender:"girls", company:"Inkode", title:"iLy", year:2025, debut:false, youtubeId:"XceS5vnJvUg", tags:["Letter: I"], highlight:87, songStart:0, color:"#00e1b4" },
  { id:"kiiikiii-idome", artist:"KiiiKiii", group:"KiiiKiii", gender:"girls", company:"Starship", title:"I DO ME", year:2025, debut:true, youtubeId:"hAEfi_SKTEU", tags:["Letter: I", "Debut"], highlight:41, songStart:0, color:"#00fff0" },
  { id:"kiiikiii-dancingalone", artist:"KiiiKiii", group:"KiiiKiii", gender:"girls", company:"Starship", title:"DANCING ALONE", year:2025, debut:false, youtubeId:"u5wMLWs6LSs", tags:["Letter: D"], highlight:50, songStart:0, color:"#c819ff" },
  { id:"kiiikiii-btg", artist:"KiiiKiii", group:"KiiiKiii", gender:"girls", company:"Starship", title:"BTG", year:2025, debut:false, youtubeId:"hnCd1RyTaOA", tags:["Letter: B"], highlight:34, songStart:0, color:"#7c00a3" },
  { id:"ifeye-ruok", artist:"ifeye", group:"ifeye", gender:"girls", company:"HI-HAT", title:"r u ok?", year:2025, debut:false, youtubeId:"tGMy0z1akLs", tags:["Letter: R"], highlight:91, songStart:0, color:"#22afff" },
  { id:"ifeye-nerdy", artist:"ifeye", group:"ifeye", gender:"girls", company:"HI-HAT", title:"NERDY", year:2025, debut:true, youtubeId:"I_msu2-4UAU", tags:["Letter: R","Debut"], highlight:46, songStart:0, color:"#22afff" }, 
  { id:"aespa-supernova", artist:"aespa", group:"aespa", gender:"girls", company:"SM", title:"Supernova", year:2024, debut:false, youtubeId:"phuiiNCxRMg", tags:["Letter: S"], highlight:40, songStart:0, color:"#2e8100" },
  { id:"aespa-drama", artist:"aespa", group:"aespa", gender:"girls", company:"SM", title:"Drama", year:2023, debut:false, youtubeId:"D8VEhcPeSlc", tags:["Letter: D"], highlight:57, songStart:0, color:"#ed0500" },
  { id:"lesserafim-hot", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"HOT", year:2025, debut:false, youtubeId:"r9AEGPB6qIU", tags:["Letter: H"], highlight:43, songStart:0, color:"#ff9e00" },
  { id:"lesserafim-easy", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"EASY", year:2024, debut:false, youtubeId:"bNKXxwOQYB8", tags:["Letter: E"], highlight:82, songStart:0, color:"#f4f4f4" },
  { id:"lesserafim-pnight", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"Perfect Night", year:2023, debut:false, youtubeId:"hLvWy2b857I", tags:["Letter: P"], highlight:47, songStart:0, color:"#ff1eed" },
  { id:"lesserafim-smart", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"Smart", year:2024, debut:false, youtubeId:"KNexS61fjus", tags:["Letter: S"], highlight:61, songStart:0, color:"#ff7a00" },
  { id:"lesserafim-anti", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"ANTIFRAGILE", year:2022, debut:false, youtubeId:"pyf8cbqyfPs", tags:["Letter: A"], highlight:62, songStart:0, color:"#e0d059" },
  { id:"lesserafim-diff", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"DIFFERENT", year:2025, debut:false, youtubeId:"HFZUAXhdnHk", tags:["Letter: D"], highlight:52, songStart:0, color:"#ef8af5" },
  { id:"lesserafim-kawaii", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"Kawaii (Prod. Gen Hoshino)", year:2025, debut:false, youtubeId:"DY4ckIx94xw", tags:["Letter: K"], highlight:65, songStart:0, color:"#ff82e4" },
  { id:"lesserafim-fearless", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"FEARLESS", year:2022, debut:true, youtubeId:"4vbDFu0PUew", tags:["Letter: F"], highlight:43, songStart:0, color:"#313131" },
  { id:"lesserafim-unforgiven", artist:"LE SSERAFIM", group:"LE SSERAFIM", gender:"girls", company:"HYBE", title:"UNFORGIVEN", year:2023, debut:false, youtubeId:"UBURTj20HXI", tags:["Letter: U"], highlight:99, songStart:0, color:"#9f0013" },
  { id:"newjeans-eta", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"ETA", year:2023, debut:false, youtubeId:"jOTfBlKSQYY", tags:["Letter: E"], highlight:71, songStart:0, color:"#237400" },
  { id:"newjeans-sshy", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"Super Shy", year:2023, debut:false, youtubeId:"ArmDp-zijuc", tags:["Letter: S"], highlight:55, songStart:0, color:"#fcff7a" },
  { id:"newjeans-attention", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"Attention", year:2022, debut:true, youtubeId:"js1CtxSY38I", tags:["Letter: A"], highlight:71, songStart:0, color:"#00ffff" },
  { id:"newjeans-ditto", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"Ditto", year:2023, debut:false, youtubeId:"pSUydWEqKwE", tags:["Letter: D"], highlight:137, songStart:0, color:"#00ffff" },
  { id:"newjeans-hypeboy", artist:"NewJeans", group:"NewJeans", gender:"girls", company:"HYBE", title:"Hype Boy", year:2022, debut:false, youtubeId:"11cta61wi0g", tags:["Letter: H"], highlight:53, songStart:0, color:"#001fdc" },
  { id:"ive-afterlike", artist:"IVE", group:"IVE", gender:"girls", company:"Starship", title:"After LIKE", year:2023, debut:false, youtubeId:"F0B7HDiY-10", tags:["Letter: A"], highlight:31, songStart:0, color:"#0fff00" },
  { id:"ive-iam", artist:"IVE", group:"IVE", gender:"girls", company:"Starship", title:"I AM", year:2023, debut:false, youtubeId:"6ZUIwj3FgUY", tags:["Letter: I"], highlight:51, songStart:0, color:"#b5fff5" },
  { id:"ive-attitude", artist:"IVE", group:"IVE", gender:"girls", company:"Starship", title:"ATTITUDE", year:2025, debut:false, youtubeId:"38xYeot-ciM", tags:["Letter: A"], highlight:50, songStart:0, color:"#efc5ff" },
  { id:"ive-rebelheart", artist:"IVE", group:"IVE", gender:"girls", company:"Starship", title:"REBEL HEART", year:2025, debut:false, youtubeId:"g36q0ZLvygQ", tags:["Letter: R"], highlight:50, songStart:0, color:"#f5004e" },
  { id:"h2h-chase", artist:"Hearts2Hearts", group:"Hearts2Hearts", gender:"girls", company:"SM", title:"The Chase", year:2025, debut:true, youtubeId:"kxUA2wwYiME", tags:["Letter: T"], highlight:85, songStart:0, color:"#5196ff" },
  { id:"yena-nemo", artist:"YENA", group:"YENA", gender:"girls", company:"Stone", title:"NEMONEMO", year:2024, debut:false, youtubeId:"MPp8hbuZwW0", tags:["Letter: N", "Soloist"], highlight:56, songStart:0, color:"#ff4eed" },
  { id:"yena-smiley", artist:"YENA", group:"YENA", gender:"girls", company:"Stone", title:"SMILEY (Feat. BIBI)", year:2022, debut:true, youtubeId:"y9kkXTucnLU", tags:["Letter: S", "Soloist"], highlight:74, songStart:0, color:"#fbff42" },
  { id:"qwer-tbh", artist:"QWER", group:"QWER", gender:"girls", company:"TAMAGO", title:"T.B.H", year:2024, debut:false, youtubeId:"ImuWa3SJulY", tags:["Letter: T"], highlight:65, songStart:0, color:"#ff00db" },
  { id:"qwer-malgeum", artist:"QWER", group:"QWER", gender:"girls", company:"TAMAGO", title:"My Name Is Malguem", year:2024, debut:false, youtubeId:"AlirzLFEHUI", tags:["Letter: M"], highlight:70, songStart:0, color:"#c0ffb9" },
  { id:"fiftyfifty-pookie", artist:"FIFTY FIFTY", group:"FIFTY FIFTY", gender:"girls", company:"ATTRAKT", title:"Pookie", year:2025, debut:false, youtubeId:"1ZX1vEDTfY4", tags:["Letter: P"], highlight:50, songStart:0, color:"#00c2ff" },
  { id:"fiftyfifty-sos", artist:"FIFTY FIFTY", group:"FIFTY FIFTY", gender:"girls", company:"ATTRAKT", title:"SOS", year:2024, debut:false, youtubeId:"XpZTcLSH6Cc", tags:["Letter: S"], highlight:39, songStart:0, color:"#8402ae" },
  { id:"stayc-teddy", artist:"STAYC", group:"STAYC", gender:"girls", company:"High Up", title:"Teddy Bear", year:2023, debut:false, youtubeId:"SxHmoifp0oQ", tags:["Letter: T"], highlight:41, songStart:0, color:"#6d008f" },
  { id:"stayc-bubble", artist:"STAYC", group:"STAYC", gender:"girls", company:"High Up", title:"Bubble", year:2023, debut:false, youtubeId:"3-ptVHZZdBg", tags:["Letter: B"], highlight:43, songStart:0, color:"#ff448b" },
  { id:"stayc-asap", artist:"STAYC", group:"STAYC", gender:"girls", company:"High Up", title:"ASAP", year:2021, debut:false, youtubeId:"NsY-9MCOIAQ", tags:["Letter: A"], highlight:45, songStart:0, color:"#ff9aeb" },
  { id:"izone-panorama", artist:"IZ*ONE", group:"IZ#ONE", gender:"girls", company:"Off The Record", title:"Panorama", year:2020, debut:false, youtubeId:"G8GaQdW2wHc", tags:["Letter: P"], highlight:56, songStart:0, color:"#eaeaea" },
  { id:"izone-rose", artist:"IZ*ONE", group:"IZ#ONE", gender:"girls", company:"Off The Record", title:"La Vie en Rose", year:2018, debut:false, youtubeId:"WZwr2a_lFWY", tags:["Letter: L"], highlight:62, songStart:0, color:"#ca0000" },

  { id:"sajaboys-youridol", artist:"Saja Boys", group:"Saja Boys", gender:"boys", company:"K-Pop Demon Hunters", title:"Your Idol", year:2025, debut:false, youtubeId:"2FS3JAPTKXs", tags:["Letter: Y"], highlight:45, songStart:0, color:"#c00070" },
  { id:"sajaboys-soda", artist:"Saja Boys", group:"Saja Boys", gender:"boys", company:"K-Pop Demon Hunters", title:"Soda Pop", year:2025, debut:false, youtubeId:"hAyPTJFgFEs", tags:["Letter: S"], highlight:68, songStart:0, color:"#ff54b7" },
  { id:"enhypen-drunk", artist:"ENHYPEN", group:"ENHYPEN", gender:"boys", company:"HYBE", title:"Drunk-Dazed", year:2021, debut:false, youtubeId:"Fc7-Oe0tj5k", tags:["Letter: D"], highlight:74, songStart:0, color:"#f87171" },

]);

/* ---------- Stats persistence ---------- */
const STATS_KEY = "kpop_sodo_stats_v1";
function loadStats(){
  try{
    const raw = localStorage.getItem(STATS_KEY);
    if(!raw) return { total:0, songs:{}, artists:{} };
    const s = JSON.parse(raw);
    return { total: Number(s.total||0), songs: s.songs||{}, artists: s.artists||{} };
  }catch{ return { total:0, songs:{}, artists:{} }; }
}
function saveStats(stats){ localStorage.setItem(STATS_KEY, JSON.stringify(stats)); }
function resetStats(){
  const empty = { total:0, songs:{}, artists:{} };
  saveStats(empty);
  return empty;
}
let STATS = loadStats();

/* Precompute song index for quick lookups */
const SONG_INDEX = Object.fromEntries(SONGS.map(s => [s.id, s]));

/* ---------- Helpers ---------- */
const rand = (n)=>Math.floor(Math.random()*n);
const sample = (arr)=> arr.length?arr[rand(arr.length)]:null;
const escapeHtml = (s)=>String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
function embedUrl(yid, startSec){
  const base=`https://www.youtube-nocookie.com/embed/${yid}?autoplay=0&modestbranding=1&rel=0`;
  const start = (startSec && startSec>0) ? `&start=${Math.floor(startSec)}` : "";
  return base + start;
}
/* color helpers */
function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=(h<<5)-h+str.charCodeAt(i); h|=0; } return Math.abs(h); }
function generatedColorFor(song, side){
  const h = (hashCode(song?.id || side) % 360 + (side==='right'?24:0)) % 360;
  return `hsl(${h} 80% 55%)`;
}
function getSongColor(song, side){
  const c = (song && typeof song.color==='string' && song.color.trim()) ? song.color.trim() : null;
  return c || generatedColorFor(song, side);
}
function setPageGradient(leftColor, rightColor){
  const root = document.documentElement;
  root.style.setProperty('--left', leftColor);
  root.style.setProperty('--right', rightColor);
}

/* ---------- Tag normalization ---------- */
function normTag(t){
  const pretty = String(t).trim();
  const [k,...rest] = pretty.split(":");
  const v = rest.join(":");
  const key = (k||"").trim().toLowerCase();
  const val = (v||"").trim().toLowerCase();
  const norm = `${key}:${val}`;
  return { pretty, key, val, norm };
}
function songHasNormTag(song, normStr){
  if(!song.tags) return false;
  return song.tags.some(t=> normTag(t).norm === normStr);
}

/* ---------- Static categories ---------- */
const StaticCats = {
  random: { label: "Random (each round)", genPairs(){ return []; } },
  any:    { label: "Any", genPairs(songs){ return allPairs(songs); } },
  boysVgirls: { label:"Boys vs Girls", genPairs(s){return pairWhere(s,a=>a.gender==="boys",b=>b.gender==="girls");}},
  girlsVgirls:{ label:"Girls vs Girls", genPairs(s){return pairWhere(s,a=>a.gender==="girls",b=>b.gender==="girls",true);}},
  boysVboys:  { label:"Boys vs Boys",  genPairs(s){return pairWhere(s,a=>a.gender==="boys",b=>b.gender==="boys",true);}},
  companySMvJYP:{label:"SM Ent. vs JYP Ent.", genPairs(s){return pairWhere(s,a=>a.company==="SM",b=>b.company==="JYP");}},
  companySMvHYBE:{label:"SM Ent. vs HYBE", genPairs(s){return pairWhere(s,a=>a.company==="SM",b=>b.company==="HYBE");}},
  companyHYBEvJYP:{label:"JYP Ent. vs HYBE", genPairs(s){return pairWhere(s,a=>a.company==="JYP",b=>b.company==="HYBE");}},
  companySMvYG:{label:"SM Ent. vs YG Ent.", genPairs(s){return pairWhere(s,a=>a.company==="SM",b=>b.company==="YG");}},
  companyYGvJYP:{label:"JYP Ent. vs YG Ent.", genPairs(s){return pairWhere(s,a=>a.company==="JYP",b=>b.company==="YG");}},
  companyHYBEvYG:{label:"YG Ent. vs HYBE", genPairs(s){return pairWhere(s,a=>a.company==="YG",b=>b.company==="HYBE");}},
  sameYear:   { label:"Same Release Year", genPairs(s){return allPairs(s).filter(([a,b])=>a.year&&b.year&&a.year===b.year);}},
  year:       { label:(y)=>`Year ${y}`, genPairs(s,o){const y=Number(o?.year);return allPairs(s.filter(x=>x.year===y));}},
  startsWith: { label:(L)=>`Starts with the letter ${String(L||"").toUpperCase()}`,
                genPairs(s,o){const L=String(o?.letter||"").toUpperCase();return allPairs(s.filter(x=>x.title?.toUpperCase().startsWith(L)));}},
  debut:      { label:"Debut Songs", genPairs(s){return allPairs(s.filter(x=>x.debut===true));}},
  sameGroup:  { label:"Same Group", genPairs(s){return allPairs(s).filter(([a,b])=>a.group&&b.group&&a.group===b.group);}},
};

/* ---------- Dynamic categories from tags ---------- */
function buildDynamicTagCategories(songs){
  const counts = new Map();
  for(const s of songs){
    for(const t of (s.tags||[])){
      const nt = normTag(t);
      const rec = counts.get(nt.norm) || { pretty: nt.pretty, count:0 };
      rec.count++; counts.set(nt.norm, rec);
    }
  }
  const dyn = {};
  for(const [norm, rec] of counts){
    if(rec.count >= 2){
      const key = `tag|${norm}`;
      dyn[key] = {
        label: rec.pretty,
        genPairs(songs){ const pool = songs.filter(s=>songHasNormTag(s, norm)); return allPairs(pool); }
      };
    }
  }
  return dyn;
}

/* ---------- Pair helpers ---------- */
function allPairs(list){
  const res=[]; for(let i=0;i<list.length;i++){ for(let j=i+1;j<list.length;j++){ res.push([list[i],list[j]]); } } return res;
}
function pairWhere(songs, predA, predB, allowSame=false){
  const A=songs.filter(predA), B=songs.filter(predB), out=[];
  for(const a of A){ for(const b of B){ if(!allowSame && a.id===b.id) continue; out.push([a,b]); } }
  return out;
}

/* ---------- App state ---------- */
const DYN = buildDynamicTagCategories(SONGS);
let currentPair=[null,null], champion=null, picks=0, currentCatKey=null;

/* Reveal + pending */
const revealed = { left:false, right:false };
const pending = { left:null, right:null };

/* Auto reveal timers (track per side) */
const autoTimers = { left:null, right:null };

const els={
  categorySelect:document.getElementById('categorySelect'),
  yearInput:document.getElementById('yearInput'),
  letterInput:document.getElementById('letterInput'),
  categoryLabel:document.getElementById('categoryLabel'),
  ruleBadge:document.getElementById('ruleBadge'),
  left:{ frame:document.querySelector('#leftCard iframe'), artist:document.getElementById('leftArtist'), title:document.getElementById('leftTitle'), tags:document.getElementById('leftTags') },
  right:{ frame:document.querySelector('#rightCard iframe'), artist:document.getElementById('rightArtist'), title:document.getElementById('rightTitle'), tags:document.getElementById('rightTags') },
  saveLeft:document.getElementById('saveLeft'),
  saveRight:document.getElementById('saveRight'),
  score:document.getElementById('score'),
  newPair:document.getElementById('btnNewPair'),
  // modal bits
  btnOptions:document.getElementById('btnOptions'),
  optsDlg:document.getElementById('opts'),
  btnCloseOpts:document.getElementById('btnCloseOpts'),
  btnDoneOpts:document.getElementById('btnDoneOpts'),
  toggleHighlight:document.getElementById('toggleHighlight'),
  championMode:document.getElementById('championMode'),
  autoReveal:document.getElementById('autoReveal'),
  revealOrder:document.getElementById('revealOrder'),
  showTags:document.getElementById('showTags'),
  btnHardRefresh:document.getElementById('btnHardRefresh'),
  // stats
  btnStats:document.getElementById('btnStats'),
  statsDlg:document.getElementById('statsDlg'),
  btnCloseStats:document.getElementById('btnCloseStats'),
  btnDoneStats:document.getElementById('btnDoneStats'),
  btnResetStats:document.getElementById('btnResetStats'),
  topArtists:document.getElementById('topArtists'),
  topSongs:document.getElementById('topSongs'),
  totalChoicesLabel:document.getElementById('totalChoicesLabel'),
  // reveal controls
  revealLeft:document.getElementById('revealLeft'),
  revealRight:document.getElementById('revealRight'),
  // sfx
  sfxPop:document.getElementById('sfxPop'),
};

/* ---------- Category UI ---------- */
function refreshCategoryDropdown(){
  const sel = els.categorySelect;
  sel.innerHTML = "";
  const add = (value,label,disabled=false)=> {
    const o=document.createElement('option'); o.value=value; o.textContent=label; if(disabled)o.disabled=true; sel.appendChild(o);
  };
  add("random","ðŸŽ² Random (each round)");
  add("any","Any");
  add("boysVgirls","Boys vs Girls");
  add("girlsVgirls","Girls vs Girls");
  add("boysVboys","Boys vs Boys");
  add("companySMvJYP","SM Ent. vs JYP Ent.");
  add("companySMvHYBE","SM Ent. vs HYBE");
  add("companyHYBEvJYP","JYP Ent. vs HYBE");
  add("companySMvYG","SM Ent. vs YG Ent");
  add("companyYGvJYP","JYP Ent. vs YG Ent");
  add("companyHYBEvYG","HYBE vs YG Ent");
  add("sameYear","Same Release Year");
  add("year","Specific Yearâ€¦");
  add("startsWith","Starts with Letterâ€¦");
  add("debut","Debut Songs");
  add("sameGroup","Same Group");
  add("sep","â€” Tags as Categories â€”", true);

  for(const key of Object.keys(DYN).sort()){
    add(key, DYN[key].label);
  }

  sel.value = "random";
  updateCategoryUI();
}
function updateCategoryUI(){
  const val = els.categorySelect.value;
  els.yearInput.style.display = (val==="year") ? "inline-block" : "none";
  els.letterInput.style.display = (val==="startsWith") ? "inline-block" : "none";
}

/* ---------- Start-time helpers ---------- */
function startSecondsFor(song){
  const useHighlight = els.toggleHighlight.checked;
  const highlight = Number(song.highlight||0);
  const songStart = Number(song.songStart||0);
  return useHighlight ? highlight : songStart;
}

/* ---------- SFX ---------- */
function playPop(){
  try{
    const a = els.sfxPop.cloneNode(true);
    a.volume = 1;
    a.play().catch(()=>{});
  }catch{}
}

/* ---------- Reveal helpers ---------- */
function setVoteEnabled(){
  const canVote = revealed.left && revealed.right;
  els.saveLeft.disabled  = !canVote;
  els.saveRight.disabled = !canVote;
}
function concealSide(side){
  revealed[side] = false;
  const cardId = side==='left' ? 'leftCard' : 'rightCard';
  document.getElementById(cardId).classList.add('concealed');
}
function revealSide(side){
  if (revealed[side]) return;
  const p = pending[side]; if(!p) return;

  clearAutoTimer(side);

  const dest = els[side];
  dest.frame.src = p.url;
  dest.artist.textContent = p.song.artist;
  dest.title.textContent  = p.song.title;
  dest.tags.innerHTML = els.showTags.checked ? renderTags(p.song) : "";
  const cardId = side==='left' ? 'leftCard' : 'rightCard';
  document.getElementById(cardId).classList.remove('concealed');
  revealed[side] = true;
  setVoteEnabled();

  playPop();

  if (els.autoReveal.checked){
    const other = side==='left' ? 'right' : 'left';
    if (!revealed[other] && !autoTimers[other]){
      autoTimers[other] = setTimeout(()=>{
        autoTimers[other]=null;
        revealSide(other);
      }, AUTO_GAP_MS);
    }
  }
}

/* ---------- Auto reveal scheduling ---------- */
function clearAutoTimer(side){
  if (autoTimers[side]){ clearTimeout(autoTimers[side]); autoTimers[side]=null; }
}
function clearAllAutoTimers(){ clearAutoTimer('left'); clearAutoTimer('right'); }

function pickRevealOrder(){
  const mode = els.revealOrder.value;
  if (mode === 'leftFirst')  return ['left','right'];
  if (mode === 'rightFirst') return ['right','left'];
  return Math.random()<0.5 ? ['left','right'] : ['right','left'];
}

function scheduleAutoReveal(){
  clearAllAutoTimers();
  if(!els.autoReveal.checked) return;

  const [first, second] = pickRevealOrder();

  if (!revealed.left && !revealed.right){
    autoTimers[first]  = setTimeout(()=>{ autoTimers[first]=null;  revealSide(first); },  AUTO_FIRST_MS);
    autoTimers[second] = setTimeout(()=>{ autoTimers[second]=null; revealSide(second); }, AUTO_FIRST_MS + AUTO_GAP_MS);
  } else if (revealed.left && !revealed.right){
    autoTimers.right = setTimeout(()=>{ autoTimers.right=null; revealSide('right'); }, AUTO_GAP_MS);
  } else if (revealed.right && !revealed.left){
    autoTimers.left = setTimeout(()=>{ autoTimers.left=null; revealSide('left'); }, AUTO_GAP_MS);
  }
}

/* ---------- Round logic ---------- */
function getRuleLabelFromKey(key){
  if(key?.startsWith("tag|")) return DYN[key]?.label || "Tag";
  const cat = StaticCats[key] || StaticCats.any;
  if (key==="year") return StaticCats.year.label(els.yearInput.value||"â€”");
  if (key==="startsWith") return StaticCats.startsWith.label((els.letterInput.value||"â€”").toUpperCase());
  return typeof cat.label==="function" ? cat.label() : cat.label;
}
function setRuleLabel(key){
  const label = getRuleLabelFromKey(key);
  els.categoryLabel.textContent = "Category: " + label;
  els.ruleBadge.textContent = label.toUpperCase();
}
function availableRandomKeys(){
  const base = ["any","boysVgirls","girlsVgirls","boysVboys","companySMvJYP","sameYear","debut","sameGroup"];
  const dyn = Object.keys(DYN);
  return [...base, ...dyn];
}
function nextPair(keepChampion=false){
  clearAllAutoTimers();

  const chosenKey = (els.categorySelect.value==="random" && !keepChampion)
    ? sample(availableRandomKeys())
    : (keepChampion ? currentCatKey : els.categorySelect.value);

  currentCatKey = chosenKey;

  const cat = chosenKey.startsWith("tag|") ? DYN[chosenKey]
              : (StaticCats[chosenKey] || StaticCats.any);
  const opts = { year:Number(els.yearInput.value||0), letter:(els.letterInput.value||"").toUpperCase() };
  const pairs = cat.genPairs(SONGS, opts) || [];
  if (!pairs.length){ alert("No pairs match this category. Add more songs or change the rule."); return; }

  let pair;
  if (keepChampion && champion){
    const filtered = pairs.filter(([a,b])=>a.id===champion.id || b.id===champion.id);
    pair = sample(filtered.length?filtered:pairs);
  } else {
    pair = sample(pairs);
    champion = null;
  }
  if (Math.random()<0.5) pair = [pair[1], pair[0]];
  currentPair = pair;

  applySongToSide(pair[0], 'left');
  applySongToSide(pair[1], 'right');
  setRuleLabel(chosenKey);

  setPageGradient(getSongColor(pair[0],'left'), getSongColor(pair[1],'right'));

  // ensure vote buttons are OFF at the start of the round
  revealed.left = false; revealed.right = false;
  setVoteEnabled();

  scheduleAutoReveal();
}

/* ---------- Apply song to side (concealed by default) ---------- */
function applySongToSide(song, side){
  const dest = els[side];
  const url = embedUrl(song.youtubeId, startSecondsFor(song));
  pending[side] = { song, url };

  dest.frame.src = "";
  dest.artist.textContent = "â€”";
  dest.title.textContent  = "â€”";
  dest.tags.innerHTML = "";

  const cardEl = document.getElementById(side==='left' ? 'leftCard' : 'rightCard');
  const color = getSongColor(song, side);
  if (side==='left') cardEl.style.setProperty('--left', color);
  else cardEl.style.setProperty('--right', color);

  concealSide(side);
}

function renderTags(s){
  const chips=[];
  if (s.group) chips.push(`<span class="tag">Group: ${escapeHtml(s.group)}</span>`);
  if (s.company) chips.push(`<span class="tag">Company: ${escapeHtml(s.company)}</span>`);
  if (s.gender) chips.push(`<span class="tag">${escapeHtml(s.gender)}</span>`);
  if (s.year) chips.push(`<span class="tag">Year: ${s.year}</span>`);
  if (s.debut) chips.push(`<span class="tag">Debut</span>`);
  if (s.highlight!=null) chips.push(`<span class="tag">Highlight: ${Math.floor(s.highlight)}s</span>`);
  if (s.songStart) chips.push(`<span class="tag">Song start: ${Math.floor(s.songStart)}s</span>`);
  if (s.color) chips.push(`<span class="tag">Color</span>`);
  (s.tags||[]).forEach(t=> chips.push(`<span class="tag">${escapeHtml(t)}</span>`));
  return chips.join("");
}

/* ---------- Stats logic ---------- */
function recordSave(song){
  STATS.total = (STATS.total || 0) + 1;
  STATS.songs[song.id]   = (STATS.songs[song.id] || 0) + 1;
  STATS.artists[song.artist] = (STATS.artists[song.artist] || 0) + 1;
  saveStats(STATS);
}
function topNFromMap(map, n, mapToName){
  const arr = Object.entries(map); // [key,count]
  arr.sort((a,b)=>{
    if (b[1] !== a[1]) return b[1] - a[1];               // count desc
    const an = mapToName(a[0]) || a[0];
    const bn = mapToName(b[0]) || b[0];
    return an.localeCompare(bn);                          // tie-break by name
  });
  return arr.slice(0, n);
}
function renderStats(){
  // total
  els.totalChoicesLabel.textContent = `Total choices: ${STATS.total || 0}`;

  // artists
  const topArtists = topNFromMap(STATS.artists || {}, 5, (artist)=>artist);
  els.topArtists.innerHTML = topArtists.length
    ? topArtists.map(([artist,count])=>(
        `<li><span class="name">${escapeHtml(artist)}</span><span class="count">${count}</span></li>`
      )).join("")
    : `<div class="empty">No saves yet â€” go play a round!</div>`;

  // songs
  const topSongs = topNFromMap(STATS.songs || {}, 5, (id)=> (SONG_INDEX[id]?.title ? `${SONG_INDEX[id].artist} â€” ${SONG_INDEX[id].title}` : id) );
  els.topSongs.innerHTML = topSongs.length
    ? topSongs.map(([id,count])=>{
        const s = SONG_INDEX[id];
        const label = s ? `${s.artist} â€” ${s.title}` : id;
        return `<li><span class="name">${escapeHtml(label)}</span><span class="count">${count}</span></li>`;
      }).join("")
    : `<div class="empty">No saves yet â€” go play a round!</div>`;
}

/* ---------- Choose ---------- */
function choose(side){
  if(!(revealed.left && revealed.right)) return;
  const winner = (side==='left') ? currentPair[0] : currentPair[1];

  // record stats
  recordSave(winner);

  // keep champion if enabled
  champion = els.championMode.checked ? winner : null;

  // UI counters
  picks++; els.score.textContent = `Choices: ${picks}`;

  // next round
  nextPair(els.championMode.checked);
}

/* ---------- Hard Refresh (cache-busting) ---------- */
function hardRefresh(){
  try { if ('caches' in window) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))); } } catch(_) {}
  try { if ('serviceWorker' in navigator) { navigator.serviceWorker.getRegistrations().then(regs => regs.forEach(r => r.unregister())); } } catch(_) {}
  const url = new URL(window.location.href);
  url.searchParams.set('v', Date.now().toString());
  window.location.replace(url.toString());
}

/* ---------- Wire up ---------- */
els.categorySelect.addEventListener('change', ()=>{ updateCategoryUI(); setRuleLabel(els.categorySelect.value); });
els.yearInput.addEventListener('input', ()=> setRuleLabel('year'));
els.letterInput.addEventListener('input', ()=>{ els.letterInput.value = els.letterInput.value.toUpperCase(); setRuleLabel('startsWith'); });
document.getElementById('btnNewPair').addEventListener('click', ()=> nextPair(els.championMode.checked));

/* Options modal */
els.btnOptions.addEventListener('click', ()=> els.optsDlg.showModal());
els.btnCloseOpts.addEventListener('click', ()=> els.optsDlg.close());
els.btnDoneOpts.addEventListener('click', ()=> els.optsDlg.close());

/* Options actions */
els.btnHardRefresh.addEventListener('click', hardRefresh);

/* Stats modal */
els.btnStats.addEventListener('click', ()=>{ renderStats(); els.statsDlg.showModal(); });
els.btnCloseStats.addEventListener('click', ()=> els.statsDlg.close());
els.btnDoneStats.addEventListener('click', ()=> els.statsDlg.close());
els.btnResetStats.addEventListener('click', ()=>{
  if(!confirm("Reset all stats (artists and songs)?")) return;
  STATS = resetStats();
  renderStats();
});

/* Vote buttons */
els.saveLeft.addEventListener('click', ()=> choose('left'));
els.saveRight.addEventListener('click', ()=> choose('right'));

/* Reveal buttons */
els.revealLeft.addEventListener('click', ()=> revealSide('left'));
els.revealRight.addEventListener('click', ()=> revealSide('right'));

/* Start-at-highlight toggle updates pending/revealed players */
els.toggleHighlight.addEventListener('change', ()=>{
  ['left','right'].forEach(side=>{
    const p = pending[side];
    if (!p) return;
    const song = p.song;
    p.url = embedUrl(song.youtubeId, startSecondsFor(song));
    if (revealed[side]) els[side].frame.src = p.url;
  });
});

/* Auto reveal toggles */
els.autoReveal.addEventListener('change', ()=>{
  if (els.autoReveal.checked) scheduleAutoReveal();
  else clearAllAutoTimers();
});
els.revealOrder.addEventListener('change', ()=>{
  if (els.autoReveal.checked) scheduleAutoReveal();
});

/* Show tags toggle */
els.showTags.addEventListener('change', ()=>{
  ['left','right'].forEach(side=>{
    if (revealed[side]){
      const song = pending[side]?.song;
      els[side].tags.innerHTML = (song && els.showTags.checked) ? renderTags(song) : "";
    }
  });
});

/* ---------- Init ---------- */
refreshCategoryDropdown();
els.categorySelect.value = "random";
setRuleLabel("random");
picks = STATS.total || 0;             // keep score in sync with stats
els.score.textContent = `Choices: ${picks}`;
nextPair(false);
</script>
</body>
</html>
